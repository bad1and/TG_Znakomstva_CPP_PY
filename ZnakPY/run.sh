#!/bin/bash

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C++ –∫–æ–¥–∞
echo "üõ†  –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º C++ –∫–æ–¥..."
cd ZnakCPP
chmod +x compile.sh
./compile.sh
cd ..

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
if ! command -v python3 &> /dev/null
then
    echo "‚ùå Python3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞."
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
if [ ! -d "venv" ]; then
    echo "üêç –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üîß –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source venv/bin/activate

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install -q aiogram python-dotenv

# –°–æ–∑–¥–∞–µ–º –ë–î –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
echo "üõ¢  –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
if [ ! -f "data/maindb.sqlite3" ]; then
    echo "üî® –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ë–î..."
    mkdir -p data
    ./app/database/db_worker '{"action":"init_db","db_path":"data/maindb.sqlite3"}' > /dev/null
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ë–î —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î"
        exit 1
    fi
else
    echo "‚ÑπÔ∏è –ë–î —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
python3 -m app.main

deactivate